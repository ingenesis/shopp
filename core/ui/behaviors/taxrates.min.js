/*!
 * taxrates.js - Tax rate editor behaviors
 * Copyright Â© 2008-2011 by Ingenesis Limited
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery(document).ready(function(a){a.template("editor",a("#editor")),a.template("conditional",a("#conditional")),a.template("localrate",a("#localrate")),a.template("property-menu",a("#property-menu")),a.template("countries-menu",a("#countries-menu"));var b=!1,c=a("#no-taxrates");a("#taxrates a.edit, #addrate").click(function(d){d&&d.preventDefault(),c.hide();var e=a(this),g=(rates.length,0),h=e.parents("tr").hide(),i=a.getQueryVar("id",e.attr("href")).trim(),j=rates[i]?rates[i]:{},k=a.extend({id:i?i:"new",rate:0,compound:"off",country:!1,zone:!1,logic:"any",rules:[]},j),l=a.tmpl("editor",k),m=l.find("div.conditionals").hide().removeClass("no-conditions"),n=m.find("ul"),p=(l.find("select.logic").val(k.logic),l.find("select.country")),q=l.find("select.zone").hide().removeClass("no-zones"),s=l.find(".local-rates").hide().removeClass("no-local-rates"),t=s.find("ul"),u=l.find(".has-locals"),v=l.find(".add-locals").hide().removeClass("has-local-rates"),w=l.find(".rm-locals").hide().removeClass("no-local-rates"),x=l.find("button.upload"),z=(x.parent(),l.find("p.instructions")),A=l.find("a.cancel"),D=(l.find("#tax-rate").change(function(){this.value=asPercent(this.value,!1,4)}).change(),l.find("#tax-compound").attr("checked","on"==k.compound),l.find("button.add"));e.rules=[],p.html(a.tmpl("countries-menu")).val(k.country).change(function(b){var c=a(this),d="",e=zones[c.val()]?zones[c.val()]:!1;0!=e?(d+='<option value=""></option>',a.each(e,function(a,b){d+='<option value="'+a+'">'+b+"</option>"}),q.html(d).val(k.zone).show()):q.empty().hide()}).change(),e.cancel=function(a){a&&a.preventDefault(),b=!1,l.remove(),h.fadeIn("fast"),c.size()>0&&c.show()},A.click(e.cancel),e.addlocals=function(a){a&&a.preventDefault(),v.hide(),w.show(),u.val("true"),s.hide().removeClass("no-local-rates").show()},v.click(e.addlocals),e.rmlocals=function(a){a&&a.preventDefault(),w.hide(),v.show(),u.val("false"),s.fadeOut("fast")},w.click(e.rmlocals),x.upload({name:"ratefile",action:ajaxurl,params:{action:"shopp_upload_local_taxes",_wpnonce:a("#_wpnonce").val()},accept:"text/plain,text/xml",maxfilesize:"1048576",onSubmit:function(){t.empty(),z.empty().removeClass("error"),x.attr("disabled",!0).addClass("updating").parent().css("width","100%")},onComplete:function(b){x.removeAttr("disabled").removeClass("updating");try{r=a.parseJSON(b),r.error?z.addClass("error").html(r.error):e.addlocals(r)}catch(c){alert("LOCAL_RATES_UPLOADERR")}}}),e.addlocalrate=function(b,c){var d={id:k.id,localename:b,localerate:asNumber(c)};a.tmpl("localrate",d).appendTo(t)},e.addlocals=function(b){a.each(b,function(a,b){e.addlocalrate(a,b)}),z.empty()},k.haslocals?(void 0!=k.locals&&e.addlocals(k.locals),s.show(),w.show()):v.show(),e.addrule=function(b,c,d){b&&b.preventDefault(),c||(c=g),d||(d={}),d.id=k.id,d.ruleid=c,d.rulevalue=d.v;var f=a.tmpl("conditional",d).appendTo(n),h=f.find("input.value"),j=(f.find("select.property").html(a.tmpl("property-menu")).val(d.p).change(function(){h.unbind("keydown").unbind("keypress").suggest(suggurl+"&action=shopp_suggestions&t="+a(this).val(),{delay:500,minchars:2,format:"json"})}).change(),f.find("button.delete").click(function(a){a&&a.preventDefault(),f.remove(),e.rules.pop(),0==e.rules.length&&m.hide()}).hide());addrulebtn=f.find("button.add").click(e.addrule),f.hover(function(){j.show()},function(){j.fadeOut("fast")}),m.show(),g++,e.rules.push(g)},D.click(e.addrule),k.rules.length>0&&a.each(k.rules,function(a,b){e.addrule(!1,a,b)}),h.size()>0?l.insertAfter(h):l.prependTo("#the-list"),quickSelects(),b=e}),a("#the-list a.delete").click(function(){return confirm($tr.confirm)?!0:!1})});