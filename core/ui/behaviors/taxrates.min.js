jQuery(document).ready(function(e){e.template("editor",e("#editor")),e.template("conditional",e("#conditional")),e.template("localrate",e("#localrate")),e.template("property-menu",e("#property-menu")),e.template("countries-menu",e("#countries-menu"));var t=!1,a=e("#no-taxrates");e("#taxrates a.edit, #addrate").click(function(n){n&&n.preventDefault(),a.hide();var l=e(this),o=(rates.length,0),i=l.parents("tr").hide(),c=e.getQueryVar("id",l.attr("href")).trim(),d=rates[c]?rates[c]:{},s=e.extend({id:c?c:"new",rate:0,compound:"off",country:!1,zone:!1,logic:"any",rules:[]},d),u=e.tmpl("editor",s),p=u.find("div.conditionals").hide().removeClass("no-conditions"),f=p.find("ul"),h=(u.find("select.logic").val(s.logic),u.find("select.country")),m=u.find("select.zone").hide().removeClass("no-zones"),v=u.find(".local-rates").hide().removeClass("no-local-rates"),g=v.find("ul"),y=u.find(".has-locals"),w=u.find(".add-locals").hide().removeClass("has-local-rates"),k=u.find(".rm-locals").hide().removeClass("no-local-rates"),C=u.find("button.upload"),b=(C.parent(),u.find("p.instructions")),x=u.find("a.cancel"),z=(u.find("#tax-rate").change(function(){this.value=asPercent(this.value,!1,4)}).change(),u.find("#tax-compound").attr("checked","on"==s.compound),u.find("button.add"));l.rules=[],h.html(e.tmpl("countries-menu")).val(s.country).change(function(t){var a=e(this),n="",l=zones[a.val()]?zones[a.val()]:!1;0!=l?(n+='<option value=""></option>',e.each(l,function(e,t){n+='<option value="'+e+'">'+t+"</option>"}),m.html(n).val(s.zone).show()):m.empty().hide()}).change(),l.cancel=function(e){e&&e.preventDefault(),t=!1,u.remove(),i.fadeIn("fast"),a.size()>0&&a.show()},x.click(l.cancel),l.addlocals=function(e){e&&e.preventDefault(),w.hide(),k.show(),y.val("true"),v.hide().removeClass("no-local-rates").show()},w.click(l.addlocals),l.rmlocals=function(e){e&&e.preventDefault(),k.hide(),w.show(),y.val("false"),v.fadeOut("fast")},k.click(l.rmlocals),C.upload({name:"ratefile",action:ajaxurl,params:{action:"shopp_upload_local_taxes",_wpnonce:e("#_wpnonce").val()},accept:"text/plain,text/xml",maxfilesize:"1048576",onSubmit:function(){g.empty(),b.empty().removeClass("error"),C.attr("disabled",!0).addClass("updating").parent().css("width","100%")},onComplete:function(t){C.removeAttr("disabled").removeClass("updating");try{r=e.parseJSON(t),r.error?b.addClass("error").html(r.error):l.addlocals(r)}catch(a){alert("LOCAL_RATES_UPLOADERR")}}}),l.addlocalrate=function(t,a){var n={id:s.id,localename:t,localerate:asNumber(a)};e.tmpl("localrate",n).appendTo(g)},l.addlocals=function(t){e.each(t,function(e,t){l.addlocalrate(e,t)}),b.empty()},s.haslocals?(void 0!=s.locals&&l.addlocals(s.locals),v.show(),k.show()):w.show(),l.addrule=function(t,a,n){t&&t.preventDefault(),a||(a=o),n||(n={}),n.id=s.id,n.ruleid=a,n.rulevalue=n.v;var i=e.tmpl("conditional",n).appendTo(f),r=i.find("input.value"),c=(i.find("select.property").html(e.tmpl("property-menu")).val(n.p).change(function(){r.unbind("keydown").unbind("keypress").suggest(suggurl+"&action=shopp_suggestions&t="+e(this).val(),{delay:500,minchars:2,format:"json"})}).change(),i.find("button.delete").click(function(e){e&&e.preventDefault(),i.remove(),l.rules.pop(),0==l.rules.length&&p.hide()}).hide());addrulebtn=i.find("button.add").click(l.addrule),i.hover(function(){c.show()},function(){c.fadeOut("fast")}),p.show(),o++,l.rules.push(o)},z.click(l.addrule),s.rules.length>0&&e.each(s.rules,function(e,t){l.addrule(!1,e,t)}),i.size()>0?u.insertAfter(i):u.prependTo("#the-list"),quickSelects(),t=l}),e("#the-list a.delete").click(function(){return!!confirm($tr.confirm)})});