/*!
 * editors.js - Product & Category editor behaviors
 * Copyright Â© 2008-2010 by Ingenesis Limited
 * Licensed under the GPLv3 {@see license.txt}
 */
;function NestedMenu(a,b,c,d,e,f,g){var h=jQuery,i=this;g||(g={axis:"y"}),i.items=f,i.dataname=c,i.index=a,i.element=h('<li><div class="move"></div><input type="hidden" name="'+c.replace("[","-").replace("]","-")+'-sortorder[]" value="'+a+'" class="sortorder" /><input type="hidden" name="'+c+"["+a+'][id]" class="id" /><input type="text" name="'+c+"["+a+'][name]" class="label" /><button type="button" class="delete"><span class="shoppui-minus"></span></button></li>').appendTo(h(b).children("ul")),i.moveHandle=i.element.find("div.move"),i.sortorder=i.element.find("input.sortorder"),i.id=i.element.find("input.id"),i.label=i.element.find("input.label"),i.deleteButton=i.element.find("button.delete").bind("delete",function(){var a=h(b).find("input.deletes");""!=h(i.id).val()&&a.val(""==a.val()?h(i.id).val():a.val()+","+h(i.id).val()),f&&i.itemsElement.remove(),i.element.remove()}).click(function(){h(this).trigger("delete")}),i.items&&("list"==f.type?i.itemsElement=h("<ul></ul>").appendTo(f.target).hide():i.itemsElement=h("<li></li>").appendTo(f.target).hide()),i.selected=function(){h(b).find("ul li").removeClass("selected"),h(i.element).addClass("selected"),f&&(h(f.target).children().hide(),h(i.itemsElement).show())},i.element.click(this.selected).hover(function(){h(this).addClass("hover")},function(){h(this).removeClass("hover")}),i.label.mouseup(function(a){this.select()}).focus(function(){h(this).keydown(function(a){a.stopPropagation(),13==a.keyCode&&h(this).blur().unbind("keydown")})}),i.id.val(i.index),e&&e.id&&i.id.val(e.id),e&&e.name?i.label.val(htmlentities(e.name)):i.label.val(d+" "+i.index),h(b).children("ul").hasClass("ui-sortable")?h(b).children("ul").sortable("refresh"):h(b).children("ul").sortable(g)}function NestedMenuContent(a,b,c,d){var e=jQuery;this.contents=e('<textarea name="'+c+"["+a+'][value]" cols="40" rows="7"></textarea>').appendTo(b),d&&d.value&&this.contents.val(htmlentities(d.value))}function NestedMenuOption(a,b,c,d,e){var f=jQuery,g=this;g.index=f(b).contents().length,g.element=f('<li class="option"><div class="move"></div><input type="hidden" name="'+c+"["+a+"][options]["+this.index+'][id]" class="id" /><input type="text" name="'+c+"["+a+"][options]["+this.index+'][name]" class="label" /><button type="button" class="delete"><span class="shoppui-minus"></span></button></li>').appendTo(b),g.moveHandle=g.element.find("div.move"),g.id=g.element.find("input.id"),g.label=g.element.find("input.label"),g.deleteButton=g.element.find("button.delete").click(function(){f(g.element).remove()}),g.element.hover(function(){f(this).addClass("hover")},function(){f(this).removeClass("hover")}),g.label.click(function(){this.select()}).focus(function(){f(this).keydown(function(a){a.stopPropagation(),13==a.keyCode&&f(this).blur().unbind("keydown")})}),g.id.val(g.index),e.id&&g.id.val(e.id),e.name&&g.label.val(htmlentities(e.name)),e.name||g.label.val(d+" "+(g.index+1))}function loadVariations(a,b){if(a){var c=jQuery;c.each(a,function(a,b){b&&b.id&&addVariationOptionsMenu(b)}),c.each(b,function(a,b){"variation"==b.context&&Pricelines.add(b.options.split(","),b,"#variations-pricing")}),Pricelines.updateVariationsUI(),c.each(a,function(a,b){b&&b.options&&c.each(b.options,function(a,b){b&&b.id&&"on"==b.linked&&Pricelines.linkVariations(b.id)})})}}function addVariationOptionsMenu(a){var b=jQuery,c=b("#variations-menu"),d=b("#variations-list"),f=(b("#addVariationMenu"),b("#addVariationOption")),g=b("#linkOptionVariations"),h=variationsidx,i=new NestedMenu(h,c,"meta[options][v]",OPTION_MENU_DEFAULT,a,{target:d,type:"list"},{axis:"y",update:function(){orderOptions(c,d)}});i.addOption=function(a){var e,h,c=!1;a||(a=new Object),a.id?a.id>optionsidx&&(optionsidx=a.id):(c=!0,a.id=optionsidx),e=new NestedMenuOption(i.index,i.itemsElement,"meta[options][v]",NEW_OPTION_DEFAULT,a),optionsidx++,h=e.id.val(),e.linkIcon=b('<span class="shoppui-link"></span>').appendTo(e.moveHandle),e.linked=b('<input type="hidden" name="meta[options][v]['+i.index+"][options]["+e.index+'][linked]" class="linked" />').val(a.linked?a.linked:"off").appendTo(e.element).change(function(){"on"==b(this).val()?e.linkIcon.removeClass("hidden"):e.linkIcon.addClass("hidden")}).change(),e.selected=function(){e.element.hasClass("selected")?(d.find("ul li").removeClass("selected"),selectedMenuOption=!1):(d.find("ul li").removeClass("selected"),b(e.element).addClass("selected"),selectedMenuOption=e),g.change()},e.element.click(e.selected),productOptions[h]=e.label,e.label.blur(function(){updateVariationLabels()}),e.deleteButton.unbind("click"),e.deleteButton.click(function(){1==i.itemsElement.children().length?deleteVariationPrices([h],!0):deleteVariationPrices([h]),e.element.remove()}),c?addVariationPrices():addVariationPrices(h),d.dequeue().animate({scrollTop:d.prop("scrollHeight")-d.height()},200),e.label.click().focus().select().keydown(function(a){var b=a.keyCode||a.which;9==b&&(a.preventDefault(),e.label.blur(),f.focus())}),i.items.push(e)},i.items=new Array,a&&a.options?b.each(a.options,function(){i.addOption(this)}):(i.addOption(),i.addOption()),i.itemsElement.sortable({axis:"y",update:function(){orderVariationPrices()}}),i.element.unbind("click",i.click).click(function(){i.selected(),b(f).unbind("click").click(i.addOption)}),optionMenus[variationsidx++]=i,i.deleteButton.unbind("click").click(function(){var a=new Array;b(i.itemsElement).find("li").not(".ui-sortable-helper").find("input.id").each(function(c,d){a.push(b(d).val())}),deleteVariationPrices(a,!0),b(this).trigger("delete")}),a||(d.dequeue().animate({scrollTop:d.attr("scrollHeight")-d.height()},200),i.label.click().focus().select().keydown(function(a){var b=a.keyCode||a.which;9==b&&(a.preventDefault(),f.focus())}))}function buildVariations(){var b,c,d,e,a=jQuery,f=new Array,g=a("#variations-list ul"),h=g.length,i=h-1,j=new Array(g.length),k=new Array(g.length),l=0;for(g.each(function(b,c){k[b]=a(c).children().length,0==l?l=a(c).children().length:l*=a(c).children().length,j[b]=0}),b=0;l>b;b++){for(c=0;c<g.length;c++)d=a(g[c]).children("li").not(".ui-sortable-helper").children("input.id"),f[b]?f[b].push(a(d[j[c]]).val()):f[b]=[a(d[j[c]]).val()];if(++j[i]>=k[i])for(e=i;e>-1;e--)j[e]<k[e]||(j[e]=0,e-1>-1&&j[e-1]++)}return f}function addVariationPrices(a){if(!a){var c,d,b=jQuery,e=buildVariations(),f=b("#variations-pricing"),g=b(f).children(),h=!1;b(e).each(function(a,b){c=xorkey(b),d=xorkey(b.slice(0,b.length-1)),""==d&&(d=-1),Pricelines.row[c]||(Pricelines.row[d]?(Pricelines.row[c]=Pricelines.row[d],delete Pricelines.row[d],Pricelines.row[c].setOptions(b)):(0==g.length?Pricelines.add(b,{context:"variation"},"#variations-pricing"):Pricelines.add(b,{context:"variation"},Pricelines.row[xorkey(e[a-1])].row,"after"),h=!0))}),h&&Pricelines.updateVariationsUI()}}function deleteVariationPrices(a,b){var f,g,h,i,j,c=jQuery,d=buildVariations(),e=!1;c(d).each(function(d,k){for(g=xorkey(k),f=0;f<a.length;f++)-1!=k.indexOf(a[f])&&(h=new Array,c(k).each(function(b,c){c!=a[f]&&h.push(c)}),i=xorkey(h),b&&!Pricelines.row[i]?(0!=i?Pricelines.row[i]=Pricelines.row[g]:Pricelines.row[g].row.remove(),delete Pricelines.row[g],Pricelines.row[i]&&(Pricelines.row[i].setOptions(h),e=!0)):Pricelines.row[g]&&(j=c("#priceid-"+Pricelines.row[g].id).val(),""==c("#deletePrices").val()?c("#deletePrices").val(j):c("#deletePrices").val(c("#deletePrices").val()+","+j),Pricelines.remove(g)))}),e&&Pricelines.updateVariationsUI()}function optionMenuExists(a){if(!a)return!1;var b=jQuery,c=!1;return b.each(optionMenus,function(d,e){return e&&b(e.label).val()==a?c=d:void 0}),optionMenus[c]?optionMenus[c]:c}function optionMenuItemExists(a,b){if(!a||!a.items||!b)return!1;var c=jQuery,d=!1;return c.each(a.items,function(a,e){return e&&c(e.label).val()==b?d=!0:void 0}),d}function updateVariationLabels(){var a=jQuery,b=buildVariations();a(b).each(function(a,b){var c=xorkey(b);Pricelines.row[c]&&Pricelines.row[c].updateLabel()})}function orderOptions(a,b){var c=jQuery;c(a).find("ul li").not(".ui-sortable-helper").find("input.id").each(function(a,d){d&&c(optionMenus[c(d).val()].itemsElement).appendTo(b)}),orderVariationPrices()}function orderVariationPrices(){var b,a=jQuery,c=buildVariations();a(c).each(function(a,c){b=xorkey(c),b>0&&Pricelines.row[b]&&Pricelines.reorderVariation(b,c)}),Pricelines.updateVariationsUI("tabs")}function xorkey(a){a instanceof Array||(a=[a]);for(var b=0,c=0;c<a.length;c++)b^=7001*a[c];return b}function variationsToggle(){var a=jQuery,b=a(this),c=a("#variations"),d=a("#product-pricing");b.prop("checked")?(Pricelines.row[0]&&Pricelines.row[0].disable(),d.hide(),c.show()):(c.hide(),d.show(),Pricelines.row[0]&&Pricelines.row[0].enable())}function addonsToggle(){var a=jQuery,b=a(this),c=a("#addons");b.prop("checked")?c.show():c.hide()}function clearLinkedIcons(){jQuery("#variations-list input.linked").val("off").change()}function linkVariationsButton(){var a=jQuery;selectedMenuOption?"off"==selectedMenuOption.linked.val()?(Pricelines.allLinked()&&(clearLinkedIcons(),Pricelines.unlinkAll()),selectedMenuOption.linked.val("on").change(),Pricelines.linkVariations(selectedMenuOption.id.val())):(selectedMenuOption.linked.val("off").change(),Pricelines.unlinkVariations(selectedMenuOption.id.val())):(clearLinkedIcons(),Pricelines.allLinked()?Pricelines.unlinkAll():Pricelines.linkAll()),a(this).change()}function linkVariationsButtonLabel(){var a=jQuery;selectedMenuOption?"on"==selectedMenuOption.linked.val()?a(this).find("small").html(" "+UNLINK_VARIATIONS):a(this).find("small").html(" "+LINK_VARIATIONS):Pricelines.allLinked()?a(this).find("small").html(" "+UNLINK_ALL_VARIATIONS):a(this).find("small").html(" "+LINK_ALL_VARIATIONS)}function loadAddons(a,b){var c=jQuery;a&&(c.each(a,function(a,b){newAddonGroup(b)}),c.each(b,function(a,b){if("addon"==b.context){var c=addonOptionsGroup[b.options];Pricelines.add(b.options,this,"#addon-pricegroup-"+c)}}),Pricelines.updateVariationsUI())}function newAddonGroup(a){var b=jQuery,c=b("#addon-menu"),d=b("#addon-list"),e=b("#newAddonGroup"),f=b("#addAddonOption"),g=addon_group_idx,h=new NestedMenu(g,c,"meta[options][a]",ADDON_GROUP_DEFAULT,a,{target:d,type:"list"},{axis:"y",update:function(){orderAddonGroups()}});h.itemsElement.attr("id","addon-group-"+g),h.pricegroup=b('<div id="addon-pricegroup-'+g+'" />').appendTo("#addon-pricing"),h.pricegroupLabel=b("<label />").html("<h4>"+h.label.val()+"</h4>").prependTo(h.pricegroup),h.updatePriceLabel=function(){h.pricegroupLabel.html("<h4>"+h.label.val()+"</h4>")},h.label.blur(h.updatePriceLabel),h.addOption=function(a){var e,g,c=!1;a||(a=new Object),a.id?a.id>addonsidx&&(addonsidx=a.id):(c=!0,a.id=addonsidx),e=new NestedMenuOption(h.index,h.itemsElement,"meta[options][a]",NEW_OPTION_DEFAULT,a),addonsidx++,g=e.id.val(),e.selected=function(){e.element.hasClass("selected")?(d.find("ul li").removeClass("selected"),selectedMenuOption=!1):(d.find("ul li").removeClass("selected"),b(e.element).addClass("selected"),selectedMenuOption=e)},e.element.click(e.selected),productAddons[g]=e.label,e.label.blur(function(){Pricelines.row[g].updateLabel()}),e.deleteButton.unbind("click"),e.deleteButton.click(function(){var a=Pricelines.row[g].data.id,c=b("#deletePrices");a&&(""==c.val()?c.val(a):c.val(c.val()+","+a)),Pricelines.row[g].row.remove(),e.element.remove()}),c&&Pricelines.add(g,{context:"addon"},h.pricegroup),addonOptionsGroup[g]=h.index,h.items.push(e),d.dequeue().animate({scrollTop:d.attr("scrollHeight")-d.height()},200),e.label.click().focus().select().keydown(function(a){var b=a.keyCode||a.which;9==b&&(a.preventDefault(),e.label.blur(),f.focus())})},h.items=new Array,a&&a.options?b.each(a.options,function(){h.addOption(this)}):(h.addOption(),h.addOption()),h.itemsElement.sortable({axis:"y",update:function(){orderAddonPrices(h.index)}}),h.element.unbind("click",h.click),h.element.click(function(){h.selected(),b(f).unbind("click").click(h.addOption)}),addonGroups[addon_group_idx++]=h,h.deleteButton.unbind("click").click(function(){b("#addon-list #addon-group-"+h.index+" li").not(".ui-sortable-helper").find("input.id").each(function(a,c){var e,d=b(c).val(),f=b("#deletePrices");Pricelines.row[d]&&(e=Pricelines.row[d].data.id,e&&(""==f.val()?f.val(e):f.val(f.val()+","+e)),Pricelines.row[d].row.remove())}),h.deleteButton.trigger("delete"),h.pricegroup.remove(),h.element.remove()}),a||(c.dequeue().animate({scrollTop:c.attr("scrollHeight")-c.height()},200),h.label.click().focus().select().keydown(function(a){var b=a.keyCode||a.which;9==b&&(a.preventDefault(),h.label.blur(),e.focus())}))}function orderAddonGroups(){var b,a=jQuery;a("#addon-menu ul li").not(".ui-sortable-helper").find("input.id").each(function(c,d){b=addonGroups[a(d).val()],b.pricegroup.appendTo("#addon-pricing")})}function orderAddonPrices(a){var b=jQuery,c=addonGroups[a];b("#addon-list #addon-group-"+c.index+" li").not(".ui-sortable-helper").find("input.id").each(function(a,d){Pricelines.reorderAddon(b(d).val(),c.pricegroup)})}function readableFileSize(a){var b=new Array("bytes","KB","MB","GB"),c=1*a,d=0;if(0==c)return c;for(;c>1e3;)c/=1024,d++;return c.toFixed(2)+" "+b[d]}function addDetail(a){var c,d,b=jQuery,e=b("#details-menu"),f=b("#details-list"),g=detailsidx++,h=new NestedMenu(g,e,"details","Detail Name",a,{target:f});if(a&&a.options){d=b('<select name="details['+h.index+'][value]"></select>').appendTo(h.itemsElement),b("<option></option>").appendTo(d);for(c in a.options)b("<option>"+a.options[c].name+"</option>").appendTo(d);a&&a.value&&d.val(htmlentities(a.value))}else h.item=new NestedMenuContent(h.index,h.itemsElement,"details",a);(!a||a.add)&&(h.add=b('<input type="hidden" name="details['+h.index+'][new]" value="true" />').appendTo(h.element),e.dequeue().animate({scrollTop:e.attr("scrollHeight")-e.height()},200),h.label.click().focus().select(),h.item&&h.item.contents.keydown(function(a){var c=a.keyCode||a.which;9==c&&(a.preventDefault(),b("#addDetail").focus())}))}function ImageUploads(a,b){function f(){c("#browser-uploader").hide(),d.loaded=!0}function g(){c("#lightbox li").size()>0&&c("#lightbox").sortable({opacity:.8})}function h(a,b,c){return b==SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED?void alert("You selected too many files to upload at one time. "+(0===c?"You have reached the upload limit.":"You may upload "+(c>1?"up to "+c+" files.":"only one file."))):void alert(c)}function i(a,b){try{this.startUpload()}catch(c){this.debug(c)}}function j(a){this.targetHolder=c('<li class="image uploading"><input type="hidden" name="images[]" /><div class="progress"><div class="bar"></div><div class="gloss"></div></div></li>').appendTo(c("#lightbox")),this.progressBar=this.targetHolder.find("div.bar"),this.sorting=this.targetHolder.find("input")}function k(a,b,c){this.progressBar.animate({width:Math.ceil(b/c*76)+"px"},100)}function l(a,b,c){}function m(a,b){var e,f,d=!1,h=this.targetHolder;try{d=c.parseJSON(b)}catch(i){return h.remove(),alert(b),!1}return d.id?(h.attr({id:"image-"+d.id}),this.sorting.val(d.id),e=c('<img src="?siid='+d.id+'" width="96" height="96" class="handle" />').appendTo(h).hide(),f=c('<button type="button" name="deleteImage" value="'+d.id+'" class="delete"><span class="shoppui-minus"></span></button>').appendTo(h).hide(),g(),void this.progressBar.animate({width:"76px"},250,function(){c(this).parent().fadeOut(500,function(){c(this).remove(),c(e).fadeIn("500"),n(f)})})):(h.remove(),d.error?alert(d.error):alert(UNKNOWN_UPLOAD_ERROR),!0)}function n(a){a.hide(),a.parent().hover(function(){a.show()},function(){a.hide()}),a.click(function(){if(confirm(DELETE_IMAGE_WARNING)){var b="<"==a.val().substr(0,1)?a.find("input[name=ieisstupid]").val():a.val(),d=c("#deleteImages"),e=d.val();d.val(""==e?b:e+","+b),c("#confirm-delete-images").show(),a.parent().fadeOut(500,function(){c(this).remove()})}})}var d,c=jQuery,e={button_text:ADD_IMAGE_BUTTON_TEXT,button_text_style:'.buttonText{text-align:center;font-family:"Lucida Grande","Lucida Sans Unicode",Tahoma,Verdana,_sans;font-size:9px;color:#333333;}',button_text_top_padding:3,button_height:"18",button_width:"100",button_image_url:uidir+"/icons/buttons.png",button_placeholder_id:"swf-uploader-button",upload_url:ajaxurl,flash_url:uidir+"/behaviors/swfupload.swf",file_queue_limit:0,file_size_limit:filesizeLimit+"b",file_types:"*.jpg;*.jpeg;*.png;*.gif",file_types_description:"Web-compatible Image Files",file_upload_limit:filesizeLimit,post_params:{action:"shopp_upload_image",parent:a,type:b},swfupload_loaded_handler:f,file_queue_error_handler:h,file_dialog_complete_handler:i,upload_start_handler:j,upload_progress_handler:k,upload_error_handler:l,upload_success_handler:m,custom_settings:{loaded:!1,targetHolder:!1,progressBar:!1,sorting:!1},prevent_swf_caching:c.ua.msie,debug:imageupload_debug};flashuploader&&(d=new SWFUpload(e)),c("#image-upload").upload({name:"Filedata",action:ajaxurl,params:{action:"shopp_upload_image",type:b},onSubmit:function(){this.targetHolder=c('<li id="image-uploading"><input type="hidden" name="images[]" value="" /><div class="progress"><div class="bar"></div><div class="gloss"></div></div></li>').appendTo("#lightbox"),this.progressBar=this.targetHolder.find("div.bar"),this.sorting=this.targetHolder.find("input")},onComplete:function(a){var d,e,b=!1,f=this.targetHolder;try{b=c.parseJSON(a)}catch(g){b.error=a}return b&&b.id?(f.attr({id:"image-"+b.id}),this.sorting.val(b.id),d=c('<img src="?siid='+b.id+'" width="96" height="96" class="handle" />').appendTo(f).hide(),e=c('<button type="button" name="deleteImage" value="'+b.src+'" class="delete"><span class="shoppui-minus"></span></button>').appendTo(c(f)).hide(),void c(this.progressBar).animate({width:"76px"},250,function(){c(this).parent().fadeOut(500,function(){c(this).remove(),c(d).fadeIn("500"),n(e)})})):(f.remove(),b.error?alert(b.error):alert(UNKNOWN_UPLOAD_ERROR),!1)}}),c(document).load(function(){d.loaded||c("#product-images .swfupload").remove()}),g(),c("#lightbox li").each(function(){c(this).dblclick(function(){var a=c(this).attr("id")+"-details",b=c("#"+a),d=b.find("input[type=hidden]").val(),e=b.find("img"),f=b.find("input.imagetitle"),g=b.find("input.imagealt"),h=b.find("input.imagecropped"),i=c('<div class="image-details-editor"><div class="details-editor"><img class="thumb" width="96" height="96" /><div class="details"><p><label>'+IMAGE_DETAILS_TITLE_LABEL+': </label><input type="text" name="title" /></p><p><label>'+IMAGE_DETAILS_ALT_LABEL+': </label><input type="text" name="alt" /></p></div></div><div class="cropping"><p class="clear">'+IMAGE_DETAILS_CROP_LABEL+': <select name="cropimage"><option></option></select></p><div class="cropui"></div><br class="clear"/></div><input type="button" class="button-primary alignright" value="&nbsp;&nbsp;'+IMAGE_DETAILS_DONE+'&nbsp;&nbsp;" /></div>'),k=(i.find("img").attr("src",e.attr("src")),i.find("input[name=title]").val(f.val()).change(function(){f.val(k.val())})),l=i.find("input[name=alt]").val(g.val()).change(function(){g.val(l.val())}),n=(i.find("input[type=button]").click(function(){c.colorbox.close()}),i.find("div.cropping").hide()),o=i.find("div.cropui"),p=i.find("select[name=cropimage]").change(function(){if(""==p.val())return o.empty(),void c.colorbox.resize();var a=p.val().split(":"),b=h.filter("input[alt="+p.val()+"]").val().split(",");o.empty().scaleCrop({imgsrc:"?siid="+d,target:{width:parseInt(a[0],10),height:parseInt(a[1],10)},init:{x:parseInt(b[0],10),y:parseInt(b[1],10),s:new Number(b[2])}}).ready(function(){var b=125;c.colorbox.resize({innerWidth:parseInt(a[0],10)+b})}).bind("change.scalecrop",function(a,b){b.s||(b.s=1),b&&h.filter("input[alt="+p.val()+"]").val(b.x+","+b.y+","+b.s)})});h.size()>0&&(h.each(function(a,b){var d=c(b).attr("alt");c('<option value="'+d+'">'+(a+1)+": "+d.replace(":","&times;")+"</option>").appendTo(p)}),n.show()),c.colorbox({title:IMAGE_DETAILS_TEXT,html:i})}),n(c(this).find("button.delete"))})}function FileUploader(a,b){function e(){c(b).hide(),this.loaded=!0}function f(a,b,c){return b==SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED?void alert("You selected too many files to upload at one time. "+(0===c?"You have reached the upload limit.":"You may upload "+(c>1?"up to "+c+" files.":"only one file."))):void alert(c)}function g(a,b){if(c.colorbox.hide(),a)try{this.startUpload()}catch(d){this.debug(d)}}function h(a){this.targetCell.attr("class","").html(""),c('<div class="progress"><div class="bar"></div><div class="gloss"></div></div>').appendTo(this.targetCell),this.progressBar=this.targetCell.find("div.bar")}function i(a,b,c){this.progressBar.animate({width:Math.ceil(b/c*76)+"px"},100)}function j(a,b){var d=!1,e=this.targetCell,f=this.targetLine;c.colorbox.close();try{d=c.parseJSON(b)}catch(g){d.error=b}return d.id||d.name?(d.type=d.type.replace(/\//gi," "),void c(this.progressBar).animate({width:"76px"},250,function(){c(this).parent().fadeOut(500,function(){c(this).remove(),c(e).attr("class","file").html('<div class="icon shoppui-file '+d.type+'"></div>'+d.name+"<br /><small>"+readableFileSize(d.size)+'</small><input type="hidden" name="price['+f+'][download]" value="'+d.id+'" />')})})):(e.html(NO_DOWNLOAD),d.error?alert(d.error):alert(UNKNOWN_UPLOAD_ERROR),!1)}var c=jQuery,d=this;d.swfu=!1,d.settings={button_text:UPLOAD_FILE_BUTTON_TEXT,button_text_style:'.buttonText{text-align:center;font-family:"Lucida Grande","Lucida Sans Unicode",Tahoma,Verdana,_sans;font-size:9px;color:#333333; }',button_text_top_padding:3,button_height:"22",button_width:"100",button_image_url:uidir+"/icons/buttons.png",button_placeholder_id:a,button_action:SWFUpload.BUTTON_ACTION.SELECT_FILE,flash_url:uidir+"/behaviors/swfupload.swf",upload_url:ajaxurl,file_queue_limit:1,file_size_limit:filesizeLimit+"b",file_types:"*.*",file_types_description:"All Files",file_upload_limit:filesizeLimit,post_params:{action:"shopp_upload_file"},swfupload_loaded_handler:e,file_queue_error_handler:f,file_dialog_complete_handler:g,upload_start_handler:h,upload_progress_handler:i,upload_success_handler:j,custom_settings:{loaded:!1,targetCell:!1,targetLine:!1,progressBar:!1},prevent_swf_caching:c.ua.msie,debug:fileupload_debug},flashuploader&&(d.swfu=new SWFUpload(d.settings)),b.upload({name:"Filedata",action:ajaxurl,params:{action:"shopp_upload_file"},onSubmit:function(){c.colorbox.hide(),d.targetCell.attr("class","").html(""),c('<div class="progress"><div class="bar"></div><div class="gloss"></div></div>').appendTo(d.targetCell),d.progressBar=d.targetCell.find("div.bar")},onComplete:function(a){c.colorbox.close();var b=!1,e=d.targetCell;try{b=c.parseJSON(a)}catch(f){b.error=a}return b.id||b.name?(b.type=b.type.replace(/\//gi," "),void c(d.progressBar).animate({width:"76px"},250,function(){c(this).parent().fadeOut(500,function(){e.attr("class","file").html('<div class="icon shoppui-file '+b.type+'"></div>'+b.name+"<br /><small>"+readableFileSize(b.size)+'</small><input type="hidden" name="price['+d.targetLine+'][download]" value="'+b.id+'" />'),c(this).remove()})})):(e.html(NO_DOWNLOAD),b.error?alert(b.error):alert(UNKNOWN_UPLOAD_ERROR),!1)}}),c(d).load(function(){d.swfu&&d.swfu.loaded||c(b).parent().parent().find(".swfupload").remove()}),d.updateLine=function(a,b){d.swfu?(d.swfu.targetLine=a,d.swfu.targetCell=b):(d.targetLine=a,d.targetCell=b)}}function SlugEditor(a,b){var c=jQuery,d=this,e=c("#edit-slug-buttons"),f=e.find(".edit"),g=e.find(".view"),h=c("#editor-slug-buttons"),i=h.find(".save"),j=h.find(".cancel"),k=c("#editable-slug-full");d.permalink=function(){var d,f=0,l=c("#editable-slug"),m=l.html(),n=c("#slug_input"),o=n.html(),p=k.html();for(e.hide(),h.show(),i.unbind("click").click(function(){var d=l.children("input").val(),f=c("#title").val();c.post(editslug_url+"&action=shopp_edit_slug",{id:a,type:b,slug:d,title:f},function(a){l.html(m),-1!=a&&(l.html(a),k.html(a),n.val(a)),g.attr("href",canonurl+k.html()),h.hide(),e.show()},"text")}),j.unbind("click").click(function(){l.html(m),h.hide(),e.show(),n.attr("value",o)}),d=0;d<p.length;++d)"%"==p.charAt(d)&&f++;slug_value=f>p.length/4?"":p,l.html('<input type="text" id="new-post-slug" value="'+slug_value+'" />').children("input").keypress(function(a){var b=a.which;(13==b||27==b)&&a.preventDefault(),13==b&&i.click(),27==b&&j.click(),n.val(this.value)}).focus()},f.click(d.permalink)}jQuery.fn.FileChooser=function(a,b){var c=jQuery,d=this,e=c("#chooser"),f=e.find(".fileimport"),g=e.find(".status"),h=c("#attach-file"),i=c("#download_path-"+a),j=c("#download_file-"+a),k=c("#file-"+a),l=!1,m=0;d.line=a,d.status=b,e.unbind("change").on("change",".fileimport",function(a){g.attr("class","status").addClass("shoppui-spinner shoppui-spinfx shoppui-spinfx-steps8"),c.ajax({url:fileverify_url+"&action=shopp_verify_file&t=download",type:"POST",data:"url="+f.val(),timeout:1e4,dataType:"text",success:function(a){return g.attr("class","status"),"OK"==a?g.addClass("shoppui-ok-sign"):("NULL"==a&&g.attr("title",FILE_NOT_FOUND_TEXT),"ISDIR"==a&&g.attr("title",FILE_ISDIR_TEXT),"READ"==a&&g.attr("title",FILE_NOT_READ_TEXT),void g.addClass("shoppui-warning-sign"))}})}),f.unbind("keydown").unbind("keypress").suggest(sugg_url+"&action=shopp_storage_suggestions&t=download",{delay:500,minchars:3,multiple:!1,onSelect:function(){f.trigger("change")}}),c(this).click(function(){fileUploads.updateLine(a,b),g.attr("class","status"),h.unbind("click").click(function(){if(c.colorbox.hide(),l)return i.val(f.val()),f.val("").attr("class","fileimport"),!0;var b=!1,e=f.val(),g=function(a){return a.name?(k.attr("class","file").html('<span class="icon shoppui-file '+a.mime.replace("/"," ")+'"></span>'+a.name+"<br /><small>"+readableFileSize(a.size)+"</small>"),i.val(a.path),j.val(a.name),void f.val("").attr("class","fileimport")):$this.attr("class","")},h=function(){var d=k.find("div.progress"),e=d.find("div.bar"),f=d.outerWidth(),i=c("#import-file-"+a).get(0).contentWindow,j=i.importProgress,l=i.importFile;if(void 0!==l){if(l.error)return k.attr("class","error").html("<small>"+l.error+"</small>");if(!l.path)return k.attr("class","error").html("<small>"+FILE_UNKNOWN_IMPORT_ERROR+"</small>");if(l.stored)return g(l);savepath=l.path.split("/"),b=savepath[savepath.length-1]}return j||(j=0),0===j&&m++>60?k.attr("class","error").html("<small>"+FILE_UNKNOWN_IMPORT_ERROR+"</small>"):(e.animate({width:Math.ceil(j*f)+"px"},100),1==j?void(e&&e.css({width:"100%"}).fadeOut(500,function(){g(l)})):void setTimeout(h,100))};setTimeout(h,100),k.attr("class","").html('<div class="progress"><div class="bar"></div><div class="gloss"></div></div><iframe id="import-file-'+a+'" width="0" height="0" src="'+fileimport_url+"&action=shopp_import_file&url="+e+'"></iframe>')})}),c(this).colorbox({title:"File Selector",innerWidth:"360",innerHeight:"140",inline:!0,href:e})};